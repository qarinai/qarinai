<div class="card p-4">
  <h2 class="text-2xl font-semibold mb-6">Add LLM Provider</h2>

  <div class="grid">
    <div class="col-12">
      <form [formGroup]="llmProviderForm" class="flex flex-wrap gap-4">
        <div class="field w-full">
          <label for="name" class="block font-medium mb-2">Provider Name <span class="text-red-500">*</span></label>
          <input
            id="name"
            type="text"
            pInputText
            formControlName="name"
            class="w-full"
            [class.ng-invalid]="llmProviderForm.get('name')?.invalid && llmProviderForm.get('name')?.touched"
          />
          <small *ngIf="llmProviderForm.get('name')?.invalid && llmProviderForm.get('name')?.touched" class="p-error">
            Provider name is required and must be at least 3 characters
          </small>
        </div>

        <div class="field w-full">
          <label for="apiBaseUrl" class="block font-medium mb-2">
            <span> API Base URL </span>
            <span class="text-red-500">*</span>
            <app-info-help infoMdFile="llm-provider-url"></app-info-help>
          </label>
          <input
            id="apiBaseUrl"
            type="text"
            pInputText
            formControlName="apiBaseUrl"
            class="w-full"
            [class.ng-invalid]="
              llmProviderForm.get('apiBaseUrl')?.invalid && llmProviderForm.get('apiBaseUrl')?.touched
            "
          />
          <small
            *ngIf="llmProviderForm.get('apiBaseUrl')?.invalid && llmProviderForm.get('apiBaseUrl')?.touched"
            class="p-error"
          >
            Valid API Base URL is required (must start with http:// or https://)
          </small>
        </div>

        <div class="field w-full">
          <label for="apiKey" class="block font-medium mb-2">API Key <span class="text-red-500">*</span></label>
          <input
            id="apiKey"
            type="password"
            pInputText
            formControlName="apiKey"
            class="w-full"
            [class.ng-invalid]="llmProviderForm.get('apiKey')?.invalid && llmProviderForm.get('apiKey')?.touched"
          />
          <small
            *ngIf="llmProviderForm.get('apiKey')?.invalid && llmProviderForm.get('apiKey')?.touched"
            class="p-error"
          >
            API Key is required
          </small>
        </div>

        <div class="flex w-full justify-end">
          <p-button
            label="Fetch Models"
            icon="pi pi-sync"
            (onClick)="fetchModels()"
            [disabled]="llmProviderForm.invalid || isLoadingModels()"
            [loading]="isLoadingModels()"
          ></p-button>
        </div>
      </form>

      @if (isModelsLoaded() && !isLoadingModels()) {
        <div class="mt-6">
          <p-divider></p-divider>

          <h3 class="text-xl font-semibold mb-3">Available Models</h3>

          <div class="flex align-items-center mb-3">
            <p-checkbox
              [binary]="true"
              [value]="true"
              [ngModel]="isAllModelsSelected()"
              (onChange)="selectAll($event)"
              [indeterminate]="selectedModels().length > 0 && !isAllModelsSelected()"
              class="ml-2"
              id="all-models-checkbox"
              name="selectAllModels"
            ></p-checkbox>
            <label for="all-models-checkbox" class="ml-2 cursor-pointer"> Select All </label>
          </div>

          <div class="grid">
            @for (model of models(); track model) {
              <div class="col-12 md:col-6 lg:col-4 mb-2">
                <div class="flex align-items-center">
                  <p-checkbox
                    id="model-{{ model }}"
                    name="selectedModels"
                    [binary]="false"
                    [value]="model"
                    [(ngModel)]="selectedModels"
                    [disabled]="!isModelsLoaded()"
                    [inputId]="'model-' + model"
                    class="ml-2"
                  ></p-checkbox>
                  <label for="model-{{ model }}" class="ml-2 cursor-pointer">
                    {{ model }}
                  </label>
                </div>
              </div>
            }
          </div>

          <div *ngIf="selectedModels().length === 0" class="p-error text-sm mb-3">Please select at least one model</div>

          <div class="flex w-full justify-end mt-4">
            <p-button
              label="Save LLM Provider"
              icon="pi pi-save"
              severity="success"
              (onClick)="save()"
              [disabled]="llmProviderForm.invalid || selectedModels().length === 0 || isSaving()"
              [loading]="isSaving()"
            ></p-button>
          </div>
        </div>
      }
    </div>
  </div>
</div>
